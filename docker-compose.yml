version: '3.8'

services:
  # =========================================
  # SUBTITLE EXTRACTOR
  # =========================================
  subtitle-extractor:
    image: ghcr.io/ghislainsamy/subtitle-extractor-translator/extractor:latest
    container_name: subtitle-extractor
    volumes:
      # Multi-folders: monter tous les dossiers
      - /mnt/nas/media/films:/media/movies
      - /mnt/nas/media/series:/media/series
      - /mnt/nas/media/documentaires:/media/documentaries
      
      # Volume pour les logs (optionnel, peut aussi √™tre dans un des dossiers ci-dessus)
      - /docker/subtitle-extractor-translator/extractor/logs:/app/logs
    environment:
      # üÜï Multi-Folders Support
      # Configuration JSON array avec les 3 dossiers
      - SOURCE_FOLDERS=["/media/movies", "/media/series", "/media/documentaries"]
      
      # Mode agent continu
      - WATCH_MODE=true
      
      # Intervalle de v√©rification (secondes)
      # 3600 = 1h, 21600 = 6h, 86400 = 24h
      - WATCH_INTERVAL=3600
      
      # üìù Logs activ√©s avec rotation automatique
      - LOG_FILE=/app/logs/extractor.log
      - LOG_FILE_MAX_SIZE_MB=10        # Taille max par fichier (MB)
      - LOG_FILE_BACKUP_COUNT=2        # Nombre de backups (total = 3 fichiers: extractor.log + .1 + .2)

      # ‚è±Ô∏è Timeouts optionnels (en secondes, laisser vide = pas de timeout)
      # - MKV_ANALYSIS_TIMEOUT=30      # Timeout pour mkvmerge -J (rapide, rarement n√©cessaire)
      # - MKV_EXTRACT_TIMEOUT=60       # Timeout pour mkvextract (utile si NAS lent)

    restart: unless-stopped

  # =========================================
  # SUBTITLE TRANSLATOR
  # =========================================
  subtitle-translator:
    image: ghcr.io/ghislainsamy/subtitle-extractor-translator/translator:latest
    container_name: subtitle-translator
    volumes:
      # Multi-folders: monter les m√™mes dossiers que l'extractor
      - /mnt/nas/media/films:/media/movies
      - /mnt/nas/media/series:/media/series
      - /mnt/nas/media/documentaires:/media/documentaries
      
      # Volume pour les logs (optionnel)
      - /docker/subtitle-extractor-translator/translator/logs:/app/logs
    environment:
      # üÜï Multi-Folders Support
      # Configuration JSON array avec les 3 dossiers
      - SOURCE_FOLDERS=["/media/movies", "/media/series", "/media/documentaries"]
      
      # Mode agent continu
      - WATCH_MODE=true
      
      # Intervalle de v√©rification (secondes)
      - WATCH_INTERVAL=3600
      
      # üìù Logs activ√©s avec rotation automatique
      - LOG_FILE=/app/logs/translator.log
      - LOG_FILE_MAX_SIZE_MB=10        # Taille max par fichier (MB)
      - LOG_FILE_BACKUP_COUNT=2        # Nombre de backups (total = 3 fichiers: translator.log + .1 + .2)
      
      # ‚ö° Performance optimis√©e : ~18 minutes pour 1945 lignes
      - PAUSE_SECONDS=10
      - BATCH_SIZE=50
      
      # üîë Cl√©s API Gemini (cr√©er sur https://aistudio.google.com/app/apikey)
      # IMPORTANT: Remplacer par vos vraies cl√©s !
      - GEMINI_API_KEYS=["votre-cl√©-1", "votre-cl√©-2", "votre-cl√©-3"]
      
      # ü§ñ Mod√®les Gemini avec quotas IND√âPENDANTS
      # Flash 2.0 (15 RPM, 1000 RPD) + Flash 1.5 (10 RPM, 250 RPD)
      # = 25 RPM total par cl√©, 1250 RPD par cl√©
      # Avec 3 cl√©s = 75 RPM, 3750 RPD (capacit√© ~96 films/jour)
      - GEMINI_MODELS=["gemini-3-flash-preview", "gemini-2.5-flash"]

      # ‚è∞ Cooldown si erreur API (secondes)
      - COOLDOWN_SECONDS=3600
      
      # üóëÔ∏è Variables de nettoyage (d√©faut: false = on garde tout)
      # Mettre √† true pour activer le nettoyage automatique en production
      
      # Supprimer .fr.progress.json apr√®s traduction ?
      - DELETE_PROGRESS_AFTER=false
      
      # Supprimer .en.XXX.tmp apr√®s traduction ?
      - DELETE_SOURCE_AFTER=false
      
      # Supprimer .to.srt.tmp apr√®s traduction ?
      - DELETE_CONVERTED_AFTER=false

      # Supprimer .en.nosubtitle.tmp (fichiers marqueurs) ?
      # - DELETE_NO_SUBTITLE_MARKER=false

    restart: unless-stopped
    
    # üîó Optionnel: faire d√©pendre le translator de l'extractor
    # Garantit que l'extractor d√©marre avant le translator
  #  depends_on:
  #    - subtitle-extractor